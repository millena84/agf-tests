<template>
    <lightning-card title="Registros CI com Relacionamentos VINC" icon-name="standard:search">
        <template if:true={ciRecords}>
            <div class="slds-p-around_medium">
                <!-- Success Indicator -->
                <div style="background: #4CAF50; color: white; padding: 15px; margin-bottom: 15px; border-radius: 4px; font-weight: bold;">
                    ‚úÖ LWC buscaCiResponse RENDERIZADO!
                    <br/>
                    <small>{ciRecords.length} registros CI encontrados</small>
                </div>

                <!-- Instru√ß√µes -->
                <div style="background: #E8F5E9; padding: 12px; margin-bottom: 15px; border-left: 4px solid #4CAF50; border-radius: 4px;">
                    <strong>‚ÑπÔ∏è Instru√ß√£o:</strong> Selecione m√∫ltiplos registros CI e/ou VINC. Voc√™ pode expandir cada CI para selecionar seus VINCs relacionados.
                </div>

                <!-- CIs com VINCs Aninhados -->
                <template for:each={ciRecords} for:item="ci">
                    <div key={ci.id} style="margin-bottom: 25px; border: 1px solid #ddd; border-radius: 4px; padding: 15px; background: #f9f9f9;">
                        
                        <!-- Se√ß√£o CI -->
                        <div style="background: #FFF3E0; padding: 12px; margin-bottom: 12px; border-left: 4px solid #FF9800; border-radius: 4px;">
                            <strong style="font-size: 14px; color: #333;">üìå CI: {ci.name}</strong>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                                ID: {ci.id}
                            </p>
                        </div>

                        <!-- DataTable de CI (single row, mas para demonstra√ß√£o de estrutura) -->
                        <div style="margin-bottom: 15px;">
                            <p style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold; color: #444;">
                                üìã Informa√ß√µes do CI:
                            </p>
                            <lightning-datatable
                                key-field="id"
                                data={ciRecords}
                                columns={ciColumns}
                                max-row-selection="1000"
                                onrowselection={handleCiRowSelection}
                                style="margin-bottom: 15px;"
                                data-ci-table={ci.id}
                            ></lightning-datatable>
                        </div>

                        <!-- VINCs Relacionados -->
                        <template if:true={ci.vincRecords}>
                            <div style="margin-top: 12px; padding: 12px; background: #E3F2FD; border-radius: 4px;">
                                <p style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold; color: #1976D2;">
                                    üîó VINCs Relacionados: {ci.vincRecords.length} registro(s)
                                </p>
                                
                                <!-- DataTable de VINCs com multi-select -->
                                <lightning-datatable
                                    key-field="id"
                                    data={ci.vincRecords}
                                    columns={vincColumns}
                                    max-row-selection="1000"
                                    onrowselection={handleVincRowSelection}
                                    data-vinc-table={ci.id}
                                ></lightning-datatable>
                            </div>
                        </template>

                        <template if:false={ci.vincRecords}>
                            <div style="padding: 10px; background: #FFF9C4; border-radius: 4px; font-size: 12px; color: #666;">
                                ‚ö†Ô∏è Nenhum VINC relacionado encontrado
                            </div>
                        </template>

                    </div>
                </template>

                <!-- Resumo e A√ß√µes -->
                <template if:true={hasSelectedRecords}>
                    <div style="background: #E3F2FD; padding: 15px; margin-top: 20px; border-left: 4px solid #2196F3; border-radius: 4px;">
                        <div class="slds-p-bottom_medium">
                            <strong>üìä Resumo de Sele√ß√£o:</strong>
                            <p style="margin: 8px 0 0 0;">
                                {selectionSummary}
                            </p>
                            <template for:each={selectedRows} for:item="row">
                                <div key={row.id} style="font-size: 12px; margin: 5px 0; padding: 5px; background: white; border-radius: 3px; border-left: 3px solid {row.type}; padding-left: 8px;">
                                    <strong>[{row.type}]</strong> {row.name} ({row.id})
                                    <template if:true={row.parentCiId}>
                                        <span style="color: #999; font-size: 11px;"> ‚Üí CI: {row.parentCiId}</span>
                                    </template>
                                </div>
                            </template>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button
                                onclick={handleConfirmSelection}
                                style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;"
                            >
                                ‚úì Confirmar Sele√ß√£o ({selectedRows.length})
                            </button>
                            <button
                                onclick={handleClearSelection}
                                style="background: #999; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;"
                            >
                                ‚úï Limpar Sele√ß√£o
                            </button>
                        </div>
                    </div>
                </template>

            </div>
        </template>

        <template if:false={ciRecords}>
            <div class="slds-p-around_medium">
                <p class="slds-text-color_weak">Nenhum registro encontrado.</p>
            </div>
        </template>
    </lightning-card>
</template>